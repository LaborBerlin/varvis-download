name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel redundant runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        node-version: ['22.x']
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Cache Quality Tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/eslint
            *.tsbuildinfo
            node_modules/.cache
          key: ${{ runner.os }}-node${{ matrix.node-version }}-quality-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.cjs') }}
          restore-keys: |
            ${{ runner.os }}-node${{ matrix.node-version }}-quality-

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --omit=dev --audit-level=high

      - name: Run linter
        run: npm run lint

      - name: Check code formatting
        run: npx prettier --check .

      - name: Type check JavaScript
        run: npm run type-check

      - name: Run tests with coverage
        run: npm test -- --coverage

      - name: Check coverage thresholds
        run: |
          echo "Coverage thresholds are enforced by Jest configuration"
          cat coverage/coverage-summary.json | jq '.total'

      # Only upload coverage from primary Node.js version to avoid duplicate reports
      - name: Upload coverage to Codecov
        if: matrix.node-version == '22.x'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: varvis-download-coverage
          fail_ci_if_error: false
          verbose: true

  bioinformatics-tools:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache apt packages
        uses: actions/cache@v5
        with:
          path: |
            /var/cache/apt/archives
          key: ${{ runner.os }}-apt-bioinformatics-${{ hashFiles('.github/workflows/test.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-bioinformatics-

      - name: Install bioinformatics tools
        run: |
          sudo apt-get update
          sudo apt-get install -y samtools tabix

      - name: Verify tool versions
        run: |
          samtools --version
          tabix --version
          bgzip --version

      - name: Install dependencies
        run: npm ci

      - name: Test genomic range functionality
        run: npm test -- --testNamePattern="range|genomic"

  integration-test:
    name: End-to-End Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Only run on push to main or pull requests to main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.base_ref == 'main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache apt packages
        uses: actions/cache@v5
        with:
          path: |
            /var/cache/apt/archives
          key: ${{ runner.os }}-apt-integration-${{ hashFiles('.github/workflows/test.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-integration-

      - name: Install Dependencies
        run: npm ci

      - name: Install Bioinformatics Tools
        run: sudo apt-get update && sudo apt-get install -y samtools tabix

      - name: Verify Bioinformatics Tools
        run: |
          echo "Verifying required tools are available..."
          samtools --version | head -1
          tabix --version 2>&1 | head -1
          bgzip --version 2>&1 | head -1

      - name: Run Integration Tests
        env:
          VARVIS_PLAYGROUND_USER: ${{ secrets.VARVIS_PLAYGROUND_USER }}
          VARVIS_PLAYGROUND_PASS: ${{ secrets.VARVIS_PLAYGROUND_PASS }}
        run: npm run test:integration
